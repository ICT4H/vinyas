# Virtual host for default port 80 to tomcat(8080)
<VirtualHost *:80>
<% if @sslEnabled == true -%>
	RewriteEngine On
    RewriteCond %{HTTPS} off
<% if @sslExcludeList.length > 0 -%>
	RewriteCond %{REMOTE_HOST} !(<%= @sslExcludeList.join("|") %>)
<% end -%>
	RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
<% end -%>

#httpd rules for authentication
<% if @authenticationRequired == true -%>
    SetEnvIf <%= @authenticationKey %> ^<%= @authenticationValue %>$ validAuthenticationKey=1

    <% if @authenticationExcludeList.length > 0 -%>
    SetEnvIf Remote_Addr <%= @authenticationExcludeList.join("|") %> validAuthenticationKey=1
    RewriteCond %{ENV:validAuthenticationKey} !=1
    RewriteRule (.*) /$1 [R=401]
    <% end -%>
    <% @redirectionRules.each do |str| -%>
        ProxyPass <%= str %>
        ProxyPassReverse <%= str %>
    <% end -%>
    RewriteCond %{ENV:validAuthenticationKey} !=1
    RewriteRule (.*) /$1 [R=401]
<% end -%>

<% if @httpRedirects.length > 0 -%>
<% @httpRedirects.each do |str| -%>
	ProxyPass <%= str %>
	ProxyPassReverse <%= str %>
<% end -%>
<% end -%>
</VirtualHost>

# Virtual host for couchdb clustering
<% if @couchdbClusteringEnabled == true -%>
<VirtualHost *:<%= @couchdbClusterPort %>>
	ProxyPass / balancer://hotcluster/
	<Proxy balancer://hotcluster>
		BalancerMember http://<%= @couchdbPrimaryIp %>:5984
		BalancerMember http://<%= @couchdbSecondaryIp %>:5984 status=+H
	</Proxy>
</VirtualHost>
<% end -%>

